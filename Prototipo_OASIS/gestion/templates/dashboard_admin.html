{% extends 'base.html' %}
{% load static %}

{% block title %}Centro de Control Administrativo{% endblock %}

{% block content %}
<style>
    /* Estilo para el Jumbotron mejorado, aprovechando las variables CSS del usuario */
    .sena-jumbotron {
        background: linear-gradient(135deg, var(--sena-green-dark) 0%, var(--sena-green-darker) 100%);
        border: 4px solid var(--sena-orange); /* Toque naranja para el contraste */
        border-radius: 1.25rem !important;
        position: relative;
        overflow: hidden;
        animation: fadeInUp 0.8s ease-out;
    }
    .sena-jumbotron::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background: var(--sena-green-light);
        opacity: 0.1;
        border-radius: 50%;
        transform: translate(50%, -50%);
    }
    .sena-jumbotron h1, .sena-jumbotron p {
        color: var(--white);
    }
    .sena-jumbotron .text-muted-sena {
        color: rgba(255, 255, 255, 0.7) !important;
    }

    /* Estilos espec√≠ficos para la tabla, forzando la est√©tica del CSS personalizado */
    .table-sena-header th {
        background: linear-gradient(135deg, var(--sena-green) 0%, var(--sena-green-dark) 100%);
        color: var(--white) !important;
    }
</style>

<div class="container mt-5">
    <!-- Jumbotron de Bienvenida del Administrador (Optimizado con SENA-Theme) -->
    <div class="sena-jumbotron p-5 mb-5 shadow-xl">
        <div class="d-flex align-items-center">
            <!-- Icono con animaci√≥n sutil -->
            <i class="bi bi-shield-lock-fill me-4 fs-1" style="color: var(--sena-orange); animation: pulse 2s ease-in-out infinite;"></i>
            <div>
                <h1 class="display-5 fw-bold mb-1">Centro de Control OASIS</h1>
                <p class="fs-6 mb-0 text-muted-sena">Gesti√≥n de plataforma y administraci√≥n de usuarios y contenidos.</p>
            </div>
        </div>
        <div class="mt-3 small text-end text-white-50">
            √öltimo acceso: {{ user.last_login|date:"d/m/Y H:i" }}
        </div>
    </div>

    <!-- Estad√≠sticas generales (Usando la clase dashboard-stat de tu CSS) -->
    <h3 class="mb-4 text-center text-sena fw-light">üìä M√©tricas Clave de la Plataforma</h3>
    <div class="row text-center g-4 mb-5">
        
        <!-- Tarjeta 1: Total de Usuarios -->
        <div class="col-md-3">
            <div class="dashboard-stat">
                <i class="bi bi-people-fill text-sena dashboard-stat-icon"></i>
                <p class="mb-0 small">Total de Usuarios</p>
                <h3 class="fw-bold">{{ total_usuarios }}</h3>
            </div>
        </div>

        <!-- Tarjeta 2: Instructores -->
        <div class="col-md-3">
            <div class="dashboard-stat">
                <i class="bi bi-person-video3 text-success dashboard-stat-icon" style="color: #10B981;"></i>
                <p class="mb-0 small">Instructores Activos</p>
                <h3 class="fw-bold" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">{{ usuarios_por_rol.instructores }}</h3>
            </div>
        </div>
        
        <!-- Tarjeta 3: Empresas -->
        <div class="col-md-3">
            <div class="dashboard-stat">
                <i class="bi bi-building-fill text-info dashboard-stat-icon" style="color: #3B82F6;"></i>
                <p class="mb-0 small">Empresas Registradas</p>
                <h3 class="fw-bold" style="background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">{{ usuarios_por_rol.empresas }}</h3>
            </div>
        </div>

        <!-- Tarjeta 4: Proyectos Pendientes -->
        <div class="col-md-3">
            <div class="dashboard-stat">
                <i class="bi bi-file-earmark-bar-graph text-warning dashboard-stat-icon" style="color: #F59E0B;"></i>
                <p class="mb-0 small">Proyectos Pendientes</p>
                <h3 class="fw-bold" style="background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">{{ proyectos_pendientes_count|default:0 }}</h3>
                {% if proyectos_pendientes_count > 0 %}
                    <span class="stat-change negative small">¬°Revisi√≥n urgente!</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Acciones principales -->
    <h3 class="mb-4 text-center text-sena fw-light">üöÄ Accesos de Gesti√≥n R√°pida</h3>
    <div class="card shadow-lg p-4 mb-5 border-sena">
        <div class="row g-3 text-center">
            
            <!-- Listar Usuarios (btn-primary, tu gradiente verde) -->
            <div class="col-md-4">
                <a href="{% url 'gestion:listar_usuarios' %}" class="btn btn-primary w-100 py-3 d-flex align-items-center justify-content-center">
                    <i class="bi bi-person-lines-fill me-2 fs-5"></i> Listar Usuarios
                </a>
            </div>
            <!-- Crear Usuario (btn-success, tu gradiente verde m√°s claro) -->
            <div class="col-md-4">
                <a href="{% url 'gestion:crear_usuario' %}" class="btn btn-success w-100 py-3 d-flex align-items-center justify-content-center">
                    <i class="bi bi-person-plus-fill me-2 fs-5"></i> Crear Usuario
                </a>
            </div>
            <!-- Gestionar Programas (btn-info) -->
            <div class="col-md-4">
                <a href="{% url 'gestion:gestion_programas' %}" class="btn btn-info w-100 py-3 d-flex align-items-center justify-content-center">
                    <i class="bi bi-book-fill me-2 fs-5"></i> Gestionar Programas
                </a>
            </div>
            <!-- Gestionar Sectores (btn-warning) -->
            <div class="col-md-4">
                <a href="{% url 'gestion:gestion_sectores' %}" class="btn btn-warning w-100 py-3 d-flex align-items-center justify-content-center">
                    <i class="bi bi-house-door-fill me-2 fs-5"></i> Gestionar Sectores
                </a>
            </div>
            <!-- Aprobar Proyectos (btn-danger, color de alerta) -->
            <div class="col-md-4">
                <a href="{% url 'gestion:revisar_solicitudes' %}" class="btn btn-danger w-100 py-3 d-flex align-items-center justify-content-center">
                    <i class="bi bi-check-square-fill me-2 fs-5"></i> Aprobar Proyectos
                </a>
            </div>
            <!-- Ver Reportes (btn-secondary) -->
            <div class="col-md-4">
                <a href="{% url 'gestion:reportes' %}" class="btn btn-secondary w-100 py-3 d-flex align-items-center justify-content-center">
                    <i class="bi bi-bar-chart-line-fill me-2 fs-5"></i> Ver Reportes
                </a>
            </div>
            <div class="col-md-4">
                <a href="{% url 'lista_backups' %}" class="btn btn-secondary w-100 py-3 d-flex align-items-center justify-content-center">
                    <i class="bi bi-bar-chart-line-fill me-2 fs-5"></i>Copias de Seguridad
                </a>
             </div>
        </div>
    </div>

    <!-- Usuarios recientes (Usando la clase table-container de tu CSS) -->
    <h3 class="mt-5 mb-3 text-sena fw-light">‚≠ê √öltimos Usuarios Registrados</h3>
    
    <div class="table-container">
        {% if usuarios_recientes %}
            <div class="table-responsive">
                <!-- Usamos la clase table y table-striped para mantener la base de Bootstrap, pero con el estilo de tu CSS -->
                <table class="table table-striped table-hover align-middle">
                    <thead>
                        <!-- La clase thead ya tiene el estilo de gradiente SENA en tu CSS -->
                        <tr>
                            <th><i class="bi bi-person-vcard-fill me-1"></i> Usuario</th>
                            <th><i class="bi bi-envelope-fill me-1"></i> Email</th>
                            <th><i class="bi bi-tag-fill me-1"></i> Rol</th>
                            <th><i class="bi bi-calendar-check-fill me-1"></i> Registro</th>
                            <th class="text-center"><i class="bi bi-lightning-fill me-1"></i> Estado</th>
                            <th class="text-center"><i class="bi bi-tools me-1"></i> Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for usuario in usuarios_recientes %}
                        <tr>
                            <td class="fw-bold">{{ usuario.username }}</td>
                            <td class="text-muted small">{{ usuario.email }}</td>
                            <td><span class="badge badge-primary">{{ usuario.get_rol_display }}</span></td>
                            <td><span class="small text-muted">{{ usuario.date_joined|date:"d/m/Y H:i" }}</span></td>
                            <td class="text-center">
                                {% if usuario.is_active %}
                                    <span class="badge badge-success"><i class="bi bi-toggle-on"></i> Activo</span>
                                {% else %}
                                    <span class="badge badge-danger"><i class="bi bi-toggle-off"></i> Inactivo</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <a href="{% url 'gestion:editar_usuario' usuario.id %}" class="btn btn-sm btn-outline-primary me-2" title="Editar"><i class="bi bi-pencil-fill"></i></a>
                                <!-- Se usa data-bs-toggle para lanzar el modal de confirmaci√≥n -->
                                <button type="button" class="btn btn-sm btn-outline-danger" title="Eliminar" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal{{ usuario.id }}">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <!-- Usando la clase alert-info de tu CSS personalizado -->
            <div class="alert alert-info text-center shadow-sm">
                No hay usuarios recientes registrados.
            </div>
        {% endif %}
    </div>
    
    <!-- MODALES DE CONFIRMACI√ìN (Uno por cada usuario, o uno din√°mico con JS) -->
    <!-- Para simplicidad, generaremos el HTML del modal dentro del loop (aunque en producci√≥n se preferir√≠a uno din√°mico con JS) -->
    {% for usuario in usuarios_recientes %}
    <div class="modal fade" id="confirmDeleteModal{{ usuario.id }}" tabindex="-1" aria-labelledby="confirmDeleteModalLabel{{ usuario.id }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteModalLabel{{ usuario.id }}"><i class="bi bi-exclamation-triangle-fill me-2"></i> Confirmar Eliminaci√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ¬øEst√°s seguro de que deseas eliminar al usuario **{{ usuario.username }}** ({{ usuario.email }})? Esta acci√≥n es irreversible.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <!-- El bot√≥n que ejecuta la acci√≥n real -->
                    <a href="{% url 'gestion:eliminar_usuario' usuario.id %}" class="btn btn-danger">Eliminar Definitivamente</a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

</div>
{% endblock %}

{% block extra_js %}
<!-- Aseg√∫rate de tener cargado Bootstrap JS/jQuery en tu base.html para que los modales funcionen -->
{% endblock %}
